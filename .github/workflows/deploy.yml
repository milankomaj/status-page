name: Deploy
on:
  workflow_dispatch:
  push:
    branches:
      - master
  repository_dispatch:
  schedule:
    - cron: '0 0 1 * *'

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-node@v3
      with:
       node-version: '12'
    - run: yarn install
    - run: yarn build
    - name: Publish
      uses: cloudflare/wrangler-action@1.3.0
      with:
       apiToken: ${{ secrets.CF_API_TOKEN }}
       preCommands: |
        apt-get update && apt-get install -y jq
        export KV_NAMESPACE_ID=$(wrangler kv:namespace list | jq -c 'map(select(.title | contains("KV_STATUS_PAGE")))' | jq -r ".[0].id")
        namespace_id=$(wrangler kv:namespace list | jq -c 'map(select(.title | contains("__status-workers_sites_assets")))' | jq  -r ".[0].id")

       postCommands: |
        yarn kv-gc
    env:
     CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
  timestamp:
      runs-on: ubuntu-latest
      needs: deploy
      steps:
      - uses: actions/checkout@v3
      - name: Timestamp
        shell: bash
        run: |
           date >> ./timestamp
           zone=$(TZ='Europe/Bratislava' date -r ./timestamp)
           sed -i "11s/.*/$zone/" ./.github/README.md
           git config --global user.email ${{ secrets.EMAIL }}
           git config --global user.name ${{ secrets.NAME }}
           git add ./.github/README.md
           git commit -m "timestamp" ./.github/README.md
           git push --force
